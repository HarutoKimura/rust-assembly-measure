# Performance Measurement for Cryptographic Assembly Code

This Rust project measures and compares the performance of cryptographic field arithmetic functions implemented in assembly code. It specifically evaluates implementations generated by different backends or sources, comparing assembly in GAS format, NASM format, and code generated by the CryptOpt tool.

The goal is to benchmark these assembly variants across various cryptographic curve implementations derived from both Fiat-Rust and Fiat-C projects.

## Features

- Benchmarks multiplication (`mul`) and squaring (`square`) operations (where available).
- Supports implementations derived from both **Fiat-Rust** and **Fiat-C**.
- Compares three assembly variants for each function:
    - **GAS format** (typically output by LLVM)
    - **NASM format** (converted from GAS)
    - **CryptOpt** (optimized NASM format)
- Measures performance using CPU cycle counts (`rdtsc`).
- Employs median-of-medians approach over multiple runs for robust results.
- Includes basic correctness checks by comparing outputs (though not the primary focus).
- Supports benchmarking for the following curves/implementations:
    - Curve25519 (Fiat-Rust)
    - Curve25519-Dalek (Fiat-Rust)
    - P448 (Fiat-Rust, mul only)
    - Poly1305 (Fiat-Rust)
    - Secp256k1-Dettman (Fiat-Rust)
    - Secp256k1 (Rust-EC)
    - BLS12 (Fiat-Rust, mul only, usize)
    - Curve25519 (Fiat-C)
    - P448 (Fiat-C)
    - Poly1305 (Fiat-C)
    - Secp256k1-Dettman (Fiat-C)

## How It Works

The tool performs the following steps for a selected curve and operation:

1.  **Generate Random Inputs**: Creates appropriately sized random field elements within loose bounds.
2.  **Measure Execution Time**: Executes batches of the target operation (mul/square) using each of the three assembly variants (GAS, NASM, CryptOpt). Records cycle counts using `rdtsc` for each batch.
3.  **Calculate Median Performance**: Calculates the median cycle count across multiple batches for each assembly variant. This forms one run's result.
4.  **Repeat Measurements**: Repeats steps 1-3 multiple times (configurable).
5.  **Calculate Median-of-Medians**: Determines the final performance metric for each assembly variant by taking the median of the results from all runs.
6.  **Compare Performance**: Prints the final median-of-medians cycle counts and calculates the percentage difference between the CryptOpt version and the GAS/NASM versions.

## Usage

### Build the Project

The `build.rs` script compiles the necessary assembly files (`.asm`) into object files (`.o`) and archives them (`.a`). Cargo then links these archives.

```bash
cargo build
```

### Run Benchmarks

Execute the benchmark using `cargo run`, specifying the curve name, operation, and optionally, the number of times to repeat the median-of-medians measurement.

```bash
cargo run <curve_name> <operation> [repeat_count]
```

**Arguments:**

*   `<curve_name>`: The name of the curve/implementation to benchmark. Available options:
    *   `curve25519`
    *   `curve25519_dalek`
    *   `p448`
    *   `poly1305`
    *   `secp256k1_dettman`
    *   `secp256k1_rust_ec`
    *   `bls12`
    *   `fiat_c_curve25519`
    *   `fiat_c_p448`
    *   `fiat_c_poly1305`
    *   `fiat_c_secp256k1_dettman`
*   `<operation>`: The operation to benchmark. Available options:
    *   `mul`
    *   `square` (Note: Not available for all curves, e.g., `p448`, `bls12`)
*   `[repeat_count]` (Optional): The number of times to run the full median-of-medians measurement process. Defaults to 1.

**Example:**

```bash
# Benchmark Curve25519 multiplication, run the measurement process 5 times
cargo run curve25519 mul 5

# Benchmark Fiat-C P448 squaring (default 1 repeat)
cargo run fiat_c_p448 square
```

